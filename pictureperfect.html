<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Picture Perfect v2.0.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="games.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="game-wrapper">
        <div class="game-container">
            
            <!-- Start Screen -->
            <div id="startScreen" class="screen active">
                <div class="nav-links">
                    <a href="index.html" class="nav-link">‚Üê All Games</a>
                    <a href="leaderboard.html" class="nav-link">üèÜ Leaderboard</a>
                </div>
                
                <h1 class="game-title">Picture Perfect</h1>
                <p class="game-subtitle">Can you spot what's wrong with each image?</p>
                
                <div class="how-to-play">
                    <h3>How to Play:</h3>
                    <ul>
                        <li>‚Ä¢ 10 rounds of image inspection</li>
                        <li>‚Ä¢ Each image may be correct, stretched, or pixelated</li>
                        <li>‚Ä¢ Identify the issue (or confirm it's correct)</li>
                        <li>‚Ä¢ 100 points per correct answer</li>
                    </ul>
                </div>
                
                <!-- User status -->
                <div id="userStatus" class="mb-2">
                    <button id="signInBtn" class="btn btn-google">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Sign in with Google
                    </button>
                    <p class="loading-text mt-1">Sign in to save your score</p>
                </div>
                <div id="userSignedIn" class="mb-2 hidden">
                    <div class="user-badge">
                        <img id="userPhoto" src="" alt="">
                        <span id="userName">Player</span>
                        <span id="signOutBtn" class="sign-out">‚úï</span>
                    </div>
                </div>
                
                <button id="startGameBtn" class="btn btn-primary">Start Game</button>
                
                <p id="imageCountInfo" class="image-count"></p>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen" class="screen">
                <h1 class="game-title">Picture Perfect</h1>
                <p id="instructionText" class="game-subtitle">Is this image correct, stretched, or pixelated?</p>
                
                <!-- Game Canvas -->
                <div id="canvasContainer" class="canvas-container">
                    <canvas id="gameCanvas"></canvas>
                </div>

                <!-- Choice Buttons -->
                <div id="choice-container" class="choice-grid cols-4">
                    <button class="btn btn-choice" data-choice="correct">‚úì Correct</button>
                    <button class="btn btn-choice" data-choice="pixelated">‚ñì Pixelated</button>
                    <button class="btn btn-choice" data-choice="horizontal">‚Üî Stretched</button>
                    <button class="btn btn-choice" data-choice="vertical">‚Üï Stretched</button>
                </div>

                <!-- Scoring Display -->
                <div class="game-stats">
                    <div>
                        <p class="stat-label">Round</p>
                        <p class="stat-value"><span id="roundCounter">1</span> / 10</p>
                    </div>
                    <div class="text-center">
                        <p id="feedbackText" class="feedback-text">Pick your answer!</p>
                    </div>
                    <div style="text-align: right;">
                        <p class="stat-label">Score</p>
                        <p class="stat-value highlight" id="totalScore">0</p>
                    </div>
                </div>

                <!-- Next Button -->
                <button id="nextButton" class="btn btn-next hidden">Next Round</button>
            </div>
            
            <!-- Game Over Screen -->
            <div id="gameOverScreen" class="screen">
                <h1 class="game-title">Game Over!</h1>
                <p class="final-score-label">Final Score</p>
                <p id="finalScore" class="final-score">0</p>
                <p id="averageScore" class="game-subtitle"></p>
                
                <!-- Initials Entry -->
                <div id="initialsEntry" class="hidden mb-2">
                    <p class="game-subtitle mb-1">Enter your initials:</p>
                    <div class="score-submit">
                        <input type="text" id="initialsInput" class="initials-input" maxlength="3" placeholder="AAA" autocomplete="off">
                        <button id="submitScoreBtn" class="btn btn-primary">Submit</button>
                    </div>
                    <p id="initialsError" class="feedback-text incorrect hidden">Please choose different initials.</p>
                </div>
                
                <!-- Score submitted confirmation -->
                <div id="scoreSubmitted" class="hidden mb-2">
                    <p class="feedback-text correct">‚úì Score saved!</p>
                    <p id="playerRank" class="game-subtitle"></p>
                </div>
                
                <!-- Not signed in message -->
                <div id="notSignedInMsg" class="hidden mb-2">
                    <p class="loading-text">Sign in before playing to save your score!</p>
                </div>
                
                <!-- Leaderboard -->
                <div class="leaderboard">
                    <h3 class="leaderboard-title text-center">üèÜ Top 10 Scores</h3>
                    <div id="leaderboardList">
                        <p class="loading-text text-center">Loading...</p>
                    </div>
                </div>
                
                <button id="playAgainButton" class="btn btn-primary mt-2">Play Again</button>
            </div>
            
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // ============================================
        // FIREBASE & AUTH
        // ============================================
        let db, auth;
        let currentUser = null;
        
        const PROFANITY_LIST = [
            'ass', 'cum', 'fag', 'fuk', 'fuc', 'fck', 'dik', 'dic', 'cok', 'kok',
            'tit', 'nig', 'ngg', 'cnt', 'pis', 'sht', 'shi', 'dam', 'wtf', 'stf',
            'sex', 'xxx', 'gay', 'lez', 'jew', 'joo', 'kik', 'kkk', 'naz', 'poo',
            'cra', 'bit', 'hor', 'slu', 'who', 'whr', 'ped', 'rap', 'rac', 'hat'
        ];
        
        function containsProfanity(text) {
            const lower = text.toLowerCase();
            return PROFANITY_LIST.some(word => lower.includes(word));
        }
        
        async function initFirebase() {
            try {
                if (typeof firebaseConfig === 'undefined') {
                    console.warn('Firebase config not found');
                    return false;
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    updateAuthUI();
                });
                
                await loadImages();
                return true;
            } catch (error) {
                console.error('Firebase init error:', error);
                return false;
            }
        }
        
        function updateAuthUI() {
            const userStatus = document.getElementById('userStatus');
            const userSignedIn = document.getElementById('userSignedIn');
            const userPhoto = document.getElementById('userPhoto');
            const userName = document.getElementById('userName');
            
            if (currentUser) {
                userStatus.classList.add('hidden');
                userSignedIn.classList.remove('hidden');
                userPhoto.src = currentUser.photoURL || '';
                userName.textContent = currentUser.displayName || currentUser.email.split('@')[0];
            } else {
                userStatus.classList.remove('hidden');
                userSignedIn.classList.add('hidden');
            }
        }
        
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user') {
                    console.error('Sign in error:', error);
                }
            }
        }
        
        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }
        
        // ============================================
        // LEADERBOARD
        // ============================================
        async function loadLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (!db) {
                leaderboardList.innerHTML = '<p class="loading-text text-center">Leaderboard unavailable</p>';
                return [];
            }
            
            try {
                const snapshot = await db.collection('scores')
                    .where('gameId', '==', 'picture-perfect')
                    .orderBy('score', 'desc')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<p class="loading-text text-center">No scores yet. Be the first!</p>';
                    return [];
                }
                
                const scores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLeaderboard(scores);
                return scores;
            } catch (error) {
                console.error('Load leaderboard error:', error);
                leaderboardList.innerHTML = '<p class="feedback-text incorrect text-center">Error loading leaderboard</p>';
                return [];
            }
        }
        
        function renderLeaderboard(scores, highlightId = null) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (scores.length === 0) {
                leaderboardList.innerHTML = '<p class="loading-text text-center">No scores yet!</p>';
                return;
            }
            
            leaderboardList.innerHTML = scores.map((entry, index) => `
                <div class="leaderboard-row ${entry.id === highlightId ? 'highlight' : ''}">
                    <span class="leaderboard-rank">${index + 1}</span>
                    <span class="leaderboard-name">${entry.initials || '???'}</span>
                    <span class="leaderboard-score">${entry.score}</span>
                </div>
            `).join('');
        }
        
        async function submitScore(initials, score) {
            if (!db || !currentUser) return null;
            
            try {
                const docRef = await db.collection('scores').add({
                    gameId: 'picture-perfect',
                    initials: initials.toUpperCase(),
                    score: score,
                    userId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Submit score error:', error);
                return null;
            }
        }
        
        // ============================================
        // GAME STATE
        // ============================================
        const TOTAL_ROUNDS = 10;
        const DISTORTION_AMOUNT = 1.25;
        
        let round = 1;
        let totalScore = 0;
        let gameActive = false;
        let correctChoice = '';
        let currentImage = null;
        let imagePool = [];
        let usedImages = [];
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const choiceContainer = document.getElementById('choice-container');
        const feedbackText = document.getElementById('feedbackText');
        const nextButton = document.getElementById('nextButton');
        const playAgainButton = document.getElementById('playAgainButton');

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // ============================================
        // IMAGE LOADING
        // ============================================
        async function loadImages() {
            if (!db) {
                imagePool = [];
                return;
            }
            
            try {
                const snapshot = await db.collection('picture-perfect-images').get();
                imagePool = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const countInfo = document.getElementById('imageCountInfo');
                if (countInfo) {
                    countInfo.textContent = `${imagePool.length} images in pool`;
                }
            } catch (error) {
                console.error('Load images error:', error);
                imagePool = [];
            }
        }

        // ============================================
        // GAME FLOW
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function startGame() {
            round = 1;
            totalScore = 0;
            usedImages = [];
            
            document.getElementById('totalScore').textContent = '0';
            document.getElementById('roundCounter').textContent = '1';
            feedbackText.textContent = 'Pick your answer!';
            feedbackText.className = 'feedback-text';
            
            showScreen('gameScreen');
            resizeCanvas();
            newRound();
        }

        function newRound() {
            if (round > TOTAL_ROUNDS) {
                endGame();
                return;
            }
            
            document.getElementById('roundCounter').textContent = round;
            feedbackText.textContent = 'Pick your answer!';
            feedbackText.className = 'feedback-text';
            nextButton.classList.add('hidden');
            
            choiceContainer.querySelectorAll('.btn-choice').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            
            document.getElementById('canvasContainer').classList.remove('feedback-correct', 'feedback-incorrect');
            
            gameActive = true;
            loadImageForRound();
        }

        function getRandomChoice() {
            const baseChoices = ['correct', 'vertical', 'horizontal', 'pixelated'];
            return baseChoices[Math.floor(Math.random() * baseChoices.length)];
        }

        function loadImageForRound() {
            const available = imagePool.filter(img => !usedImages.includes(img.id));
            
            if (available.length === 0) {
                usedImages = [];
                loadImageForRound();
                return;
            }
            
            const imageData = available[Math.floor(Math.random() * available.length)];
            usedImages.push(imageData.id);
            
            correctChoice = getRandomChoice();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#333';
            ctx.font = '16px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText("Loading image...", canvas.width / 2, canvas.height / 2);
            
            currentImage = new Image();
            currentImage.crossOrigin = "Anonymous";
            
            let imageUrl = imageData.imageUrl;
            currentImage.src = imageUrl;
            
            currentImage.onload = () => {
                drawImage();
            };
            currentImage.onerror = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ef4444';
                ctx.fillText("Error loading image. Trying next...", canvas.width / 2, canvas.height / 2);
                setTimeout(loadImageForRound, 1000);
            };
        }

        function drawImage(showCorrect = false) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const choiceToDraw = showCorrect ? 'correct' : correctChoice;

            const canvasRatio = canvas.width / canvas.height;
            const imageRatio = currentImage.width / currentImage.height;
            let drawWidth, drawHeight;

            if (canvasRatio > imageRatio) {
                drawHeight = canvas.height * 0.9;
                drawWidth = drawHeight * imageRatio;
            } else {
                drawWidth = canvas.width * 0.9;
                drawHeight = drawWidth / imageRatio;
            }

            let finalWidth = drawWidth;
            let finalHeight = drawHeight;

            if (choiceToDraw === 'vertical') {
                finalHeight *= DISTORTION_AMOUNT;
            } else if (choiceToDraw === 'horizontal') {
                finalWidth *= DISTORTION_AMOUNT;
            }

            const x = (canvas.width - finalWidth) / 2;
            const y = (canvas.height - finalHeight) / 2;
            
            if (choiceToDraw === 'pixelated') {
                const pixelSize = 6;
                const tinyWidth = Math.ceil(finalWidth / pixelSize);
                const tinyHeight = Math.ceil(finalHeight / pixelSize);
                
                const tinyCanvas = document.createElement('canvas');
                tinyCanvas.width = tinyWidth;
                tinyCanvas.height = tinyHeight;
                const tinyCtx = tinyCanvas.getContext('2d');
                
                tinyCtx.drawImage(currentImage, 0, 0, tinyWidth, tinyHeight);
                
                ctx.imageSmoothingEnabled = false;
                ctx.mozImageSmoothingEnabled = false;
                ctx.webkitImageSmoothingEnabled = false;
                ctx.msImageSmoothingEnabled = false;
                ctx.drawImage(tinyCanvas, x, y, finalWidth, finalHeight);
            } else {
                ctx.imageSmoothingEnabled = true;
                ctx.drawImage(currentImage, x, y, finalWidth, finalHeight);
            }
        }

        function checkAnswer(selection) {
            if (!gameActive) return;
            gameActive = false;

            const selectedBtn = choiceContainer.querySelector(`[data-choice="${selection}"]`);
            const correctBtn = choiceContainer.querySelector(`[data-choice="${correctChoice}"]`);
            
            choiceContainer.querySelectorAll('.btn-choice').forEach(btn => {
                btn.disabled = true;
            });
            
            if (selectedBtn) selectedBtn.classList.add('selected');

            const canvasContainer = document.getElementById('canvasContainer');
            
            if (selection === correctChoice) {
                totalScore += 100;
                document.getElementById('totalScore').textContent = totalScore;
                feedbackText.textContent = '‚úì Correct! +100';
                feedbackText.className = 'feedback-text correct';
                if (selectedBtn) selectedBtn.classList.add('correct');
                canvasContainer.classList.add('feedback-correct');
            } else {
                let correctAnswerText = '';
                switch (correctChoice) {
                    case 'correct': correctAnswerText = 'It was correct'; break;
                    case 'pixelated': correctAnswerText = 'It was pixelated'; break;
                    case 'horizontal': correctAnswerText = 'It was stretched horizontally'; break;
                    case 'vertical': correctAnswerText = 'It was stretched vertically'; break;
                }
                feedbackText.textContent = '‚úó ' + correctAnswerText;
                feedbackText.className = 'feedback-text incorrect';
                if (selectedBtn) selectedBtn.classList.add('incorrect');
                if (correctBtn) correctBtn.classList.add('correct');
                canvasContainer.classList.add('feedback-incorrect');
                
                drawImage(true);
            }

            round++;
            nextButton.classList.remove('hidden');
        }

        function endGame() {
            showScreen('gameOverScreen');
            
            document.getElementById('finalScore').textContent = totalScore;
            const avgScore = totalScore / TOTAL_ROUNDS;
            document.getElementById('averageScore').textContent = `Average: ${avgScore.toFixed(0)} per round`;
            
            document.getElementById('scoreSubmitted').classList.add('hidden');
            document.getElementById('initialsError').classList.add('hidden');
            
            if (currentUser) {
                document.getElementById('initialsEntry').classList.remove('hidden');
                document.getElementById('notSignedInMsg').classList.add('hidden');
                document.getElementById('initialsInput').value = '';
                document.getElementById('initialsInput').focus();
            } else {
                document.getElementById('initialsEntry').classList.add('hidden');
                document.getElementById('notSignedInMsg').classList.remove('hidden');
            }
            
            loadLeaderboard();
        }

        async function handleScoreSubmit() {
            const initialsInput = document.getElementById('initialsInput');
            const initials = initialsInput.value.trim().toUpperCase();
            const initialsError = document.getElementById('initialsError');
            
            if (initials.length < 2 || initials.length > 3) {
                initialsError.textContent = 'Enter 2-3 characters';
                initialsError.classList.remove('hidden');
                return;
            }
            
            if (containsProfanity(initials)) {
                initialsError.textContent = 'Please choose different initials.';
                initialsError.classList.remove('hidden');
                return;
            }
            
            initialsError.classList.add('hidden');
            
            const scoreId = await submitScore(initials, totalScore);
            
            if (scoreId) {
                document.getElementById('initialsEntry').classList.add('hidden');
                document.getElementById('scoreSubmitted').classList.remove('hidden');
                
                const scores = await loadLeaderboard();
                const rank = scores.findIndex(s => s.id === scoreId) + 1;
                if (rank > 0) {
                    document.getElementById('playerRank').textContent = `You ranked #${rank}!`;
                }
                renderLeaderboard(scores, scoreId);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('signInBtn').addEventListener('click', signInWithGoogle);
        document.getElementById('signOutBtn').addEventListener('click', signOut);
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        document.getElementById('submitScoreBtn').addEventListener('click', handleScoreSubmit);

        document.getElementById('initialsInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleScoreSubmit();
            }
        });

        choiceContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-choice');
            if (btn && !btn.disabled) {
                checkAnswer(btn.dataset.choice);
            }
        });

        nextButton.addEventListener('click', newRound);
        playAgainButton.addEventListener('click', startGame);
        
        window.addEventListener('resize', () => {
            if (document.getElementById('gameScreen').classList.contains('active')) {
                resizeCanvas();
                if (currentImage && currentImage.complete) {
                    drawImage();
                }
            }
        });
        
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!nextButton.classList.contains('hidden')) {
                    newRound();
                } else if (document.getElementById('gameOverScreen').classList.contains('active')) {
                    startGame();
                } else if (document.getElementById('startScreen').classList.contains('active')) {
                    startGame();
                }
            }
            if (gameActive) {
                if (e.key === '1') checkAnswer('correct');
                if (e.key === '2') checkAnswer('pixelated');
                if (e.key === '3') checkAnswer('horizontal');
                if (e.key === '4') checkAnswer('vertical');
            }
        });

        // ============================================
        // INIT
        // ============================================
        initFirebase();
    </script>
</body>
</html>
